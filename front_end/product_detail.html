
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container my-4">
        <div id="productDetail" class="row">
            <!-- Product detail will be dynamically populated here -->
        </div>
    </div>

    <script>
        const PRODUCT_API_URL = "http://127.0.0.1:8000/api/products/";

        // Helper: Get cart from cookies
        function getCart() {
            const cart = document.cookie
                .split('; ')
                .find(row => row.startsWith('cart='));
            return cart ? JSON.parse(cart.split('=')[1]) : {};
        }

        // Helper: Save cart to cookies
        function saveCart(cart) {
            document.cookie = `cart=${JSON.stringify(cart)}; path=/;`;
        }

        // Update the cart button UI
        function updateCartUI(productId, stock, container) {
            const cart = getCart();
            const currentQty = cart[productId] || 0;

            if (currentQty > 0) {
                container.innerHTML = `
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="decreaseQuantity(${productId}, ${stock}, this)">-</button>
                        <span class="mx-2">${currentQty}</span>
                        <button class="btn btn-outline-success btn-sm" onclick="increaseQuantity(${productId}, ${stock}, this)">+</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <button class="btn btn-primary" onclick="addToCart(${productId}, ${stock}, this)">Add to Cart</button>
                `;
            }
        }

        // Add product to cart
        function addToCart(productId, stock, button) {
            const cart = getCart();
            cart[productId] = 1; // Add 1 item to the cart
            saveCart(cart);

            // Update the UI to show the counter
            const container = button.parentElement;
            updateCartUI(productId, stock, container);
        }

        // Increase product quantity in the cart
        function increaseQuantity(productId, stock, button) {
            const cart = getCart();
            const currentQty = cart[productId] || 0;

            if (currentQty < stock) {
                cart[productId] = currentQty + 1;
                saveCart(cart);

                // Update the UI
                const container = button.parentElement.parentElement;
                updateCartUI(productId, stock, container);
            }
        }

        // Decrease product quantity in the cart
        function decreaseQuantity(productId, stock, button) {
            const cart = getCart();
            const currentQty = cart[productId] || 0;

            if (currentQty > 1) {
                cart[productId] = currentQty - 1;
                saveCart(cart);

                // Update the UI
                const container = button.parentElement.parentElement;
                updateCartUI(productId, stock, container);
            } else {
                // Remove the product from the cart if the quantity is 0
                delete cart[productId];
                saveCart(cart);

                // Revert to "Add to Cart" button
                const container = button.parentElement.parentElement;
                updateCartUI(productId, stock, container);
            }
        }

        // Load product detail from the API
        async function loadProductDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                console.error("Product ID not provided in the URL.");
                return;
            }

            try {
                const response = await axios.get(`${PRODUCT_API_URL}${productId}/`);
                const product = response.data;

                const productDetail = document.getElementById('productDetail');

                let priceHTML = `<p class="fw-bold">Price: $${product.price}</p>`;
                if (product.discounted_price && product.discounted_price != product.price) {
                    priceHTML = `
                        <p class="text-muted text-decoration-line-through">Price: $${product.price}</p>
                        <p class="fw-bold text-danger">Discounted Price: $${product.discounted_price}</p>
                    `;
                }

                productDetail.innerHTML = `
                    <div class="col-md-6">
                        <img src="${product.image}" class="img-fluid" alt="${product.name}">
                    </div>
                    <div class="col-md-6">
                        <h2>${product.name}</h2>
                        ${priceHTML}
                        <p>${product.description || "No description available."}</p>
                        <div id="cartButtonContainer-${product.id}">
                            <button class="btn btn-primary" onclick="addToCart(${product.id}, ${product.stock}, this)">Add to Cart</button>
                        </div>
                    </div>
                `;

                // Initialize the cart button UI
                const cartButtonContainer = document.getElementById(`cartButtonContainer-${product.id}`);
                updateCartUI(product.id, product.stock, cartButtonContainer);
            } catch (error) {
                console.error("Error fetching product detail:", error);
            }
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadProductDetail();
        });
    </script>
</body>
</html>
